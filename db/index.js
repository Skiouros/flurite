// Generated by CoffeeScript 1.7.1
(function() {
  var Database, clc, fs, magenta, path, query, sql;

  fs = require("fs");

  path = require("path");

  query = require("pg-query");

  clc = require("cli-color");

  sql = clc.cyanBright;

  magenta = clc.redBright;

  Database = (function() {
    var instance;

    function Database() {}

    instance = null;

    Database.prototype.TRUE = "TRUE";

    Database.prototype.FALSE = "FALSE";

    Database.prototype.NULL = "NULL";

    Database.get = function() {
      return instance != null ? instance : instance = new Database();
    };

    Database.prototype.escape_var = function(obj) {
      if (obj === this.NULL) {
        return this.NULL;
      }
      switch (typeof obj) {
        case "string":
          return "'" + (obj.split("'").join("''")) + "'";
        case "boolean":
          if (obj) {
            return this.TRUE;
          } else {
            return this.FALSE;
          }
        default:
          return obj;
      }
    };

    Database.prototype.escape_name = function(obj) {
      return "\"" + obj + "\"";
    };

    Database.prototype.query = function(text, values, cb) {
      var error;
      console.log("" + (sql("SQL")) + ": " + (magenta(text)));
      try {
        return query(text, values, cb);
      } catch (_error) {
        error = _error;
        return console.log(error);
      }
    };

    Database.prototype.select = function(text, values, cb) {
      return this.query("SELECT " + text, values, cb);
    };

    Database.prototype.insert = function(table, info, ret) {
      var i, k, q, v, values;
      if ("string" === typeof ret) {
        ret = [ret];
      }
      values = [];
      for (k in info) {
        v = info[k];
        values.push(v);
      }
      q = "INSERT INTO " + (this.escape_name(table)) + " (" + (Object.keys(info).join(",")) + ") VALUES (" + (((function() {
        var _i, _ref, _results;
        _results = [];
        for (i = _i = 1, _ref = values.length; _i <= _ref; i = _i += 1) {
          _results.push("$" + i);
        }
        return _results;
      })()).join(",")) + ")";
      if (ret) {
        q = "" + q + " RETURNING " + (ret.join(","));
      }
      return this.query(q, values);
    };

    Database.prototype.update = function(table, values, conditions) {
      var condition, k, q, v, value;
      value = (function() {
        var _results;
        _results = [];
        for (k in values) {
          v = values[k];
          _results.push("" + (this.escape_name(k)) + " = " + (this.escape_var(v)));
        }
        return _results;
      }).call(this);
      condition = (function() {
        var _results;
        _results = [];
        for (k in conditions) {
          v = conditions[k];
          _results.push("" + (this.escape_name(k)) + " = " + (this.escape_var(v)));
        }
        return _results;
      }).call(this);
      q = "UPDATE " + (this.escape_name(table)) + " SET " + (value.join(", ")) + " WHERE " + (condition.join(" and "));
      return this.query(q);
    };

    Database.prototype["delete"] = function(table, conditions) {
      var condition, k, v;
      condition = (function() {
        var _results;
        _results = [];
        for (k in conditions) {
          v = conditions[k];
          _results.push("" + (this.escape_name(k)) + " = " + (this.escape_var(v)));
        }
        return _results;
      }).call(this);
      return this.query("DELETE FROM " + (this.escape_name(table)) + " WHERE " + (condition.join(" and ")));
    };

    Database.prototype.setup = function(conn_str, app) {
      query.connectionParameters = conn_str;
      this.schema = require("./schema");
      this.Model = require("./model");
      return this;
    };

    Database.prototype.load_models = function() {
      var model, name, _ref, _results;
      this.models = {};
      fs.readdirSync("models/").filter((function(_this) {
        return function(file) {
          return path.extname(file) === ".js";
        };
      })(this)).forEach((function(_this) {
        return function(file) {
          var model;
          console.log(file);
          model = require("models/" + file);
          return _this.models[model.name] = model;
        };
      })(this));
      _ref = this.models;
      _results = [];
      for (name in _ref) {
        model = _ref[name];
        if (model.associate) {
          _results.push(model.associate(this.models));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    return Database;

  })();

  module.exports = Database.get();

}).call(this);
